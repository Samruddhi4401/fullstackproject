<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Products - Grocery WebApp</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- Bootstrap & Animate.css -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    :root {
      --light-bg: #ffffff;
      --light-text: #000000;
      --dark-bg: #121212;
      --dark-text: #ffffff;
    }

    body {
      font-family: 'Poppins', sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    body.light-mode {
      background-color: var(--light-bg);
      color: var(--light-text);
    }

    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }

    .navbar {
      background-color: rgba(0, 128, 0, 0.9);
    }

    .navbar .nav-link {
      color: #fff !important;
    }

    .theme-toggle {
      cursor: pointer;
      color: white;
      margin-left: 10px;
      font-size: 20px;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    .card:hover {
      transform: scale(1.03);
    }

    .animate-heading {
      font-size: 2.5rem;
      text-align: center;
      animation: slideTop 1.5s ease-out;
      color: #28a745;
      font-weight: 600;
    }

    @keyframes slideTop {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    #message-box {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
    }

    #searchInput {
      max-width: 300px;
    }
  </style>
</head>
<body class="light-mode">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark px-4">
    <a class="navbar-brand" href="#">üõí GroceryApp</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="admin.html">Admin</a></li>
        <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
      </ul>
      <div class="d-flex align-items-center">
        <input id="searchInput" class="form-control me-2" type="search" placeholder="Search products">
        <span class="theme-toggle" onclick="toggleTheme()" id="themeIcon">üåì</span>
        <span class="nav-link text-white" id="usernameDisplay"></span>
        <a class="nav-link text-white" href="login.html" onclick="logout()">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Heading -->
  <div class="container mt-5">
    <h2 class="animate-heading">üõí  Bringing the Market to Your Home..!</h2>
    <div id="products-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4 mt-4"></div>
    <nav>
      <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
    </nav>
  </div>

  <div id="message-box" class="animate__animated animate__fadeInDown"></div>

  <script>
    const API_BASE_URL = "https://my-grocery-app-2025.netlify.app";
    const productsContainer = document.getElementById("products-container");
    const messageBox = document.getElementById("message-box");
    const searchInput = document.getElementById("searchInput");
    const pagination = document.getElementById("pagination");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const themeIcon = document.getElementById("themeIcon");

    const productMap = {};
    let allProducts = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    function showMessage(msg) {
      messageBox.innerText = msg;
      messageBox.style.display = "block";
      setTimeout(() => {
        messageBox.style.display = "none";
      }, 2000);
    }

    function addToCart(productId) {
      const qtyInput = document.getElementById(`qty-${productId}`);
      const quantity = parseInt(qtyInput.value) || 1;
      if (quantity < 1) {
        showMessage("‚ùå Please enter valid quantity.");
        return;
      }

      const product = productMap[productId];
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const existing = cart.find(p => p.name === product.name);
      if (existing) {
        existing.quantity += quantity;
      } else {
        cart.push({
          name: product.name,
          price: product.price,
          quantity: quantity,
          image: product.image
        });
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      showMessage(`‚úÖ ${quantity} √ó ${product.name} added to cart!`);
    }

    async function loadProducts() {
      try {
        const res = await fetch(`${API_BASE_URL}/products`);
        allProducts = await res.json();
        renderProducts();
      } catch (err) {
        console.error(err);
        productsContainer.innerHTML = `<p class="text-danger">‚ùå Failed to load products.</p>`;
      }
    }

    function renderProducts() {
      const searchTerm = searchInput.value.toLowerCase();
      const filtered = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));

      const totalPages = Math.ceil(filtered.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filtered.slice(start, end);

      productsContainer.innerHTML = "";
      pageProducts.forEach(product => {
        productMap[product._id] = product;
        const div = document.createElement("div");
        div.className = "col";
        div.innerHTML = `
          <div class="card h-100">
            <img src="${product.image}" class="card-img-top" alt="${product.name}" style="height: 200px; object-fit: cover;">
            <div class="card-body">
              <h5 class="card-title">${product.name}</h5>
              <p class="card-text">Price: ‚Çπ${product.price}</p>
              <div class="d-flex mb-2">
                <input type="number" id="qty-${product._id}" class="form-control me-2" min="1" value="1" />
                <button class="btn btn-success" onclick="addToCart('${product._id}')">Add to Cart</button>
              </div>
            </div>
          </div>
        `;
        productsContainer.appendChild(div);
      });

      pagination.innerHTML = "";
      if (totalPages > 1) {
        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = "page-item" + (i === currentPage ? " active" : "");
          li.innerHTML = `<button class="page-link">${i}</button>`;
          li.onclick = () => { currentPage = i; renderProducts(); };
          pagination.appendChild(li);
        }
      }
    }

    function toggleTheme() {
      const isDark = document.body.classList.contains("dark-mode");
      if (isDark) {
        document.body.classList.replace("dark-mode", "light-mode");
        localStorage.setItem("theme", "light");
        themeIcon.textContent = "üåì";
      } else {
        document.body.classList.replace("light-mode", "dark-mode");
        localStorage.setItem("theme", "dark");
        themeIcon.textContent = "‚òÄÔ∏è";
      }
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    searchInput.addEventListener("input", () => {
      currentPage = 1;
      renderProducts();
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadProducts();

      const storedTheme = localStorage.getItem("theme");
      if (storedTheme === "dark") {
        document.body.classList.remove("light-mode");
        document.body.classList.add("dark-mode");
        themeIcon.textContent = "‚òÄÔ∏è";
      }

      const user = JSON.parse(localStorage.getItem("user"));
      if (user?.name) {
        usernameDisplay.textContent = `Hi, ${user.name}`;
      }
    });
  </script>
</body>
</html>
